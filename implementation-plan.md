# RSS To Discord Lambda Function - 実装計画

## 概要分析

仕様書を基に、以下の要件を満たすAWS Lambda関数を実装する必要があります：

### 主要機能
- RSSフィードから新着記事を取得
- 前回チェック時刻以降の記事のみを処理
- Discord Webhookで記事を通知
- S3に状態を永続化
- エラーハンドリングとDiscord通知

### 技術スタック
- TypeScript + Node.js (軽量なXMLパーサーのみ依存)
- AWS Lambda (512MB, 10秒タイムアウト)
- AWS S3 (状態管理)
- EventBridge (スケジュール実行)

## 実装タスクリスト

### 1. プロジェクト基盤構築
- [x] **1.1** TypeScript + Node.jsプロジェクトの初期化
  - package.jsonの作成
  - TypeScript設定（tsconfig.json）
  - 必要な依存関係の定義（XMLパーサー、型定義）
  - プロジェクト構造の設計

- [x] **1.2** 開発環境の設定
  - ESLint/Prettierの設定（TypeScript対応）
  - テスト環境の構築（Jest + TypeScript）
  - ビルド設定（TypeScriptコンパイル）

### 2. コア機能の実装

#### 2.1 状態管理モジュール
- [x] **2.1.1** S3クライアントの実装
  - TypeScript型定義の作成
  - 状態ファイルの読み込み機能
  - 状態ファイルの保存機能
  - エラーハンドリング

- [x] **2.1.2** 状態データ構造の定義
  - TypeScriptインターフェースの定義
  - 最終チェック時刻の管理
  - フィード別の状態管理
  - 初回実行時の処理

#### 2.2 RSS取得・解析モジュール
- [x] **2.2.1** HTTPクライアントの実装
  - TypeScript型安全なHTTPクライアント
  - 3秒タイムアウト設定
  - リトライ機能（1回、合計2回試行）
  - エラーハンドリング

- [x] **2.2.2** RSSパーサーの実装
  - RSS/Atom用TypeScriptインターフェース定義
  - RSS 2.0対応
  - Atom対応
  - 記事データの正規化
  - 発行日時の解析

- [x] **2.2.3** 新着記事フィルタリング
  - 型安全な記事フィルタリング
  - pubDateによる新着判別
  - 最大10件の制限
  - 重複チェック

#### 2.3 Discord連携モジュール
- [x] **2.3.1** Webhook送信機能
  - Discord Webhook用TypeScript型定義
  - 記事投稿フォーマット実装
  - 2秒タイムアウト設定
  - エラーハンドリング

- [x] **2.3.2** エラー通知機能
  - エラー通知フォーマット実装
  - ERROR_WEBHOOK_URLとの使い分け
  - 重大エラーの分類（TypeScript enum使用）

### 3. メイン処理の実装
- [x] **3.1** Lambda handlerの実装
  - TypeScript型安全なLambda handler
  - イベント処理（AWS Lambda型定義使用）
  - 環境変数の取得・検証
  - メイン処理フローの実装

- [x] **3.2** 処理フローの統合
  - 型安全な処理フロー実装
  - 状態読み込み → RSS取得 → 記事処理 → 状態保存
  - エラー時の処理継続ロジック
  - 構造化ログ出力の実装

### 4. エラーハンドリング・ログ
- [x] **4.1** エラー分類と処理戦略
  - TypeScript型安全なエラークラス定義
  - ネットワークエラー処理
  - パースエラー処理
  - S3アクセスエラー処理

- [ ] **4.2** CloudWatch Logsの活用
  - TypeScript構造化ログの実装
  - エラーレベルの分類（TypeScript enum）
  - デバッグ情報の出力

### 5. テスト実装
- [x] **5.1** 単体テストの作成
  - TypeScript + Jestでの型安全テスト
  - 各モジュールのテスト
  - モック化されたRSSフィードテスト
  - S3インタラクションのモック

- [x] **5.2** 統合テストの作成
  - TypeScript型チェック込みのテスト
  - エンドツーエンドテスト
  - エラーシナリオテスト
  - Discord投稿のテストモード

### 6. デプロイメント準備
- [x] **6.1** ビルドスクリプトの作成
  - TypeScriptコンパイルスクリプト
  - ZIPパッケージ生成スクリプト（Windows/Linux対応）
  - 手動アップロード用の指示とガイド

- [x] **6.1.1** ローカルテストスクリプトの作成
  - 環境変数読み込み機能
  - Lambda関数のローカル実行
  - Windows/Linux対応のテストスクリプト

- [ ] **6.2** IAM設定ガイド
  - 必要なIAMロール・ポリシーの手動設定手順
  - 最小権限原則に基づく権限設定
  - EventBridge設定の手順書

### 7. ドキュメント作成
- [ ] **7.1** README.md
  - セットアップ手順
  - 環境変数の説明
  - デプロイ手順

- [ ] **7.2** 運用ドキュメント
  - トラブルシューティング
  - ログの見方
  - 設定変更手順

## 実装順序の推奨

1. **フェーズ1**: プロジェクト基盤 (タスク1)
2. **フェーズ2**: コア機能の個別実装 (タスク2.1-2.3)
3. **フェーズ3**: 統合とメイン処理 (タスク3)
4. **フェーズ4**: エラー処理とテスト (タスク4-5)
5. **フェーズ5**: デプロイとドキュメント (タスク6-7)

## 技術的考慮事項

### 依存関係の最小化
- XMLパーサー: `fast-xml-parser` + TypeScript型定義
- HTTP通信: Node.js組み込みの `https` モジュール + TypeScript型
- AWS SDK: `@aws-sdk/client-s3` (v3) - TypeScriptネイティブサポート
- TypeScript関連: `typescript`, `@types/node`, `@types/aws-lambda`

### パフォーマンス最適化
- 並行処理でのRSSフィード取得（TypeScript Promise.all）
- メモリ効率的なXML解析
- 不要なデータの早期フィルタリング
- TypeScriptコンパイル最適化

### セキュリティ考慮
- 環境変数の検証（TypeScript型ガード使用）
- HTTP URLの検証
- XMLパーサーのセキュリティ設定
- TypeScript strict modeによる型安全性確保

### デプロイメント戦略
- **ZIPファイル手動アップロード方式**を採用
- AWS Lambda コンソールでの手動デプロイ
- 手動IAM設定による初期セットアップ
- スクリプトによる自動ビルド・パッケージ生成

## 見積もり時間

- **フェーズ1**: 2-3時間
- **フェーズ2**: 8-10時間
- **フェーズ3**: 4-5時間
- **フェーズ4**: 6-8時間
- **フェーズ5**: 2-3時間 （CloudFormation削除により短縮）

**総見積もり**: 22-29時間

## デプロイメント詳細

### ZIPファイル手動アップロード方式の利点
1. **シンプル**: AWS CLIの設定や認証が不要
2. **セキュア**: ローカル環境にAWS認証情報を保存する必要がない
3. **透明性**: 何がデプロイされるかが明確
4. **デバッグ容易**: 問題発生時の原因特定が簡単
5. **アクセス制御**: AWS Consoleでの権限管理が容易

### 実装予定スクリプト
- `build.sh` / `build.bat`: TypeScriptコンパイル + 依存関係インストール + ZIPパッケージ生成
- `test-local.sh` / `test-local.bat` / `test-local.js`: ローカル環境でのLambda関数テスト実行
- `setup.md`: 初回セットアップ手順（IAM、EventBridge設定、手動デプロイ方法）

この計画に基づいて段階的に実装を進めることで、仕様要件を満たす堅牢なLambda関数を構築できます。
